<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å†™é€è´§å•ç”µå­åŒ–å·¥å…·</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 border-b-2 pb-2 mb-2">é€è´§å•ç”µå­åŒ–åŠ©æ‰‹</h1>
            <p class="text-gray-600">æ‹æ‘„æ‰‹å†™é€è´§å•ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶åˆå¹¶ä¸ºç”µå­è¡¨æ ¼ã€‚</p>
        </header>

        <!-- API Key Setup Section (Visible only if key is missing) -->
        <section id="apiKeySection" class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-xl hidden">
            <h2 class="text-xl font-semibold text-yellow-800 mb-4">ğŸ”‘ è®¾ç½® API å¯†é’¥</h2>
            <p class="text-sm text-yellow-700 mb-4">ä¸ºäº†ä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œå¯†é’¥å°†å­˜å‚¨åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>
            <div class="flex flex-col gap-3">
                <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ Gemini API Key (AIzaSy...)" 
                    class="w-full p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                <button id="saveKeyButton" class="w-full py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition">
                    ä¿å­˜å¯†é’¥å¹¶å¼€å§‹ä½¿ç”¨
                </button>
            </div>
        </section>

        <!-- Main App Content (Hidden until key is set) -->
        <div id="mainContent" class="hidden">
            
            <!-- Key Management (Small link) -->
            <div class="flex justify-end mb-4">
                <button id="resetKeyButton" class="text-xs text-gray-400 hover:text-gray-600 underline">
                    é‡ç½®/æ›´æ¢ API å¯†é’¥
                </button>
            </div>

            <!-- Step 1: Image Upload -->
            <section class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-xl">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ‰‹å†™é€è´§å•ç…§ç‰‡ (å¯å¤šé€‰)</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="file" id="imageInput" accept="image/*" multiple
                        class="flex-grow text-sm text-gray-700
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-100 file:text-blue-700
                        hover:file:bg-blue-200"
                    />
                    <button id="clearImageButton"
                            class="px-4 py-2 bg-red-500 text-white font-medium rounded-full text-sm hover:bg-red-600 transition duration-300 disabled:opacity-50"
                            disabled>
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å›¾ç‰‡
                    </button>
                </div>
            </section>

            <!-- Step 2: Processing and Indicators -->
            <section class="mb-8">
                <button id="processButton"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 disabled:opacity-50"
                        disabled>
                    å¼€å§‹å¤„ç†æ‰€æœ‰å›¾ç‰‡å¹¶è½¬åŒ–
                </button>
                <div id="loadingIndicator" class="mt-4 text-center hidden">
                    <div class="animate-spin inline-block w-6 h-6 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
                    <span id="loadingMessage" class="ml-3 text-indigo-600 font-medium">æ­£åœ¨è¯»å–å›¾ç‰‡ 1 / 0ï¼Œè¯·ç¨å€™...</span>
                </div>
                <div id="messageBox" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
            </section>

            <!-- Step 3: Results and Export -->
            <section id="resultsSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“¦ æ±‡æ€»è¯†åˆ«ç»“æœè¡¨æ ¼</h2>
                
                <div id="tableOutput" class="overflow-x-auto mb-4">
                    <!-- Table content will be rendered here -->
                </div>

                <button id="exportButton"
                        class="w-full py-2 bg-green-500 text-white font-medium rounded-xl hover:bg-green-600 transition duration-300 disabled:opacity-50"
                        disabled>
                    â¬‡ï¸ ä¸‹è½½ CSV æ–‡ä»¶ (Excel æ ¼å¼)
                </button>
            </section>

            <!-- Step 4: Preview -->
            <section id="previewSection" class="mt-8 border-t pt-6 hidden">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">é¦–å¼ å›¾ç‰‡é¢„è§ˆ</h2>
                <img id="imagePreview" class="max-w-full h-auto rounded-lg shadow-md border" />
            </section>
        </div>
    </div>

    <script type="module">
        // --- Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // --- Application State ---
        const appState = {
            apiKey: "",
            files: [],
            extractedItems: [],
            isProcessing: false,
        };

        // --- DOM Elements ---
        const D = {
            app: document.getElementById('app'),
            apiKeySection: document.getElementById('apiKeySection'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyButton: document.getElementById('saveKeyButton'),
            resetKeyButton: document.getElementById('resetKeyButton'),
            mainContent: document.getElementById('mainContent'),
            
            imageInput: document.getElementById('imageInput'),
            clearImageButton: document.getElementById('clearImageButton'),
            processButton: document.getElementById('processButton'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            loadingMessage: document.getElementById('loadingMessage'),
            tableOutput: document.getElementById('tableOutput'),
            exportButton: document.getElementById('exportButton'),
            messageBox: document.getElementById('messageBox'),
            resultsSection: document.getElementById('resultsSection'),
            imagePreview: document.getElementById('imagePreview'),
            previewSection: document.getElementById('previewSection'),
        };

        // --- Key Management Logic ---
        
        function initKeySystem() {
            // Check Local Storage
            const storedKey = localStorage.getItem('GEMINI_API_KEY');
            if (storedKey) {
                appState.apiKey = storedKey;
                showMainContent();
            } else {
                showKeySetup();
            }
        }

        function showKeySetup() {
            D.apiKeySection.classList.remove('hidden');
            D.mainContent.classList.add('hidden');
        }

        function showMainContent() {
            D.apiKeySection.classList.add('hidden');
            D.mainContent.classList.remove('hidden');
        }

        D.saveKeyButton.addEventListener('click', () => {
            const inputKey = D.apiKeyInput.value.trim();
            if (inputKey && inputKey.startsWith('AIza')) {
                localStorage.setItem('GEMINI_API_KEY', inputKey);
                appState.apiKey = inputKey;
                showMainContent();
                showMessage('å¯†é’¥å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ã€‚', 'success');
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Gemini API Key (é€šå¸¸ä»¥ AIza å¼€å¤´)');
            }
        });

        D.resetKeyButton.addEventListener('click', () => {
            if(confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ä¿å­˜çš„ API å¯†é’¥å—ï¼Ÿæ¸…é™¤åéœ€è¦é‡æ–°è¾“å…¥ã€‚')) {
                localStorage.removeItem('GEMINI_API_KEY');
                appState.apiKey = "";
                D.apiKeyInput.value = "";
                resetApp();
                showKeySetup();
            }
        });

        // --- Utility Functions ---

        function showMessage(message, type = 'info') {
            D.messageBox.textContent = message;
            D.messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');

            if (type === 'error') {
                D.messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                D.messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                D.messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
            D.messageBox.classList.remove('hidden');
        }

        function resetApp() {
            appState.files = [];
            appState.extractedItems = [];
            appState.isProcessing = false;
            
            D.imageInput.value = '';
            D.processButton.disabled = true;
            D.clearImageButton.disabled = true;
            D.exportButton.disabled = true;
            
            D.previewSection.classList.add('hidden');
            D.resultsSection.classList.add('hidden');
            D.loadingIndicator.classList.add('hidden');
            
            D.tableOutput.innerHTML = '';
            D.messageBox.classList.add('hidden');
            // Don't show message if in key setup mode
            if(appState.apiKey) showMessage('è¯·é€‰æ‹©ä¸€å¼ æˆ–å¤šå¼ é€è´§å•å›¾ç‰‡å¼€å§‹å¤„ç†ã€‚', 'info');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Data Handling & Rendering ---

        function toCSV(items) {
            // CSV Header: é€è´§å•å·, åç§°åŠè§„æ ¼, å•ä½, æ•°é‡, å•ä»·
            const headers = ["é€è´§å•å·", "åç§°åŠè§„æ ¼", "å•ä½", "æ•°é‡", "å•ä»·"];
            let csv = headers.join(',') + '\n';

            items.forEach(item => {
                const row = [
                    `"${String(item.deliveryNo || '-').replace(/"/g, '""')}"`,
                    `"${String(item.nameAndSpec || '-').replace(/"/g, '""')}"`, 
                    String(item.unit || 'åª'),
                    String(item.quantity || 0),
                    String(item.unitPrice || 0)
                ];
                csv += row.join(',') + '\n';
            });

            return csv.trim();
        }

        function renderTable(items) {
            if (!items || items.length === 0) {
                D.tableOutput.innerHTML = '<p class="text-center text-gray-500 p-4">æœªæå–åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ã€‚</p>';
                return;
            }

            // Table Header: é€è´§å•å· added as first column
            let html = `
                <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden shadow-lg">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é€è´§å•å·</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°åŠè§„æ ¼</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å•ä½</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ•°é‡</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">å•ä»·</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            items.forEach((item, index) => {
                const quantity = item.quantity || 0;
                const unitPrice = item.unitPrice || 0;
                const priceDisplay = typeof unitPrice === 'number' ? `Â¥${unitPrice.toFixed(2)}` : '-';
                
                let priceClass = "text-gray-600";
                let rowClass = index % 2 ===
