<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å†™é€è´§å•ç”µå­åŒ–å·¥å…·</title>
    
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
            background-color: #f7f9fb; /* æµ…ç°è‰²èƒŒæ™¯ */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        /* ä¼˜åŒ–è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„ç„¦ç‚¹æ•ˆæœ */
        input:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4); /* indigo-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-700 border-b-2 border-indigo-100 pb-3 mb-2">æ‰‹å†™é€è´§å•ç”µå­åŒ–åŠ©æ‰‹</h1>
            <p class="text-gray-600">æ‹æ‘„æ‰‹å†™é€è´§å•ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶åˆå¹¶ä¸ºç”µå­è¡¨æ ¼ã€‚</p>
        </header>

        <!-- API Key è®¾ç½®åŒº (å½“ Key ä¸¢å¤±æ—¶æ˜¾ç¤º) -->
        <section id="apiKeySection" class="mb-8 p-6 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner hidden">
            <h2 class="text-xl font-semibold text-yellow-800 mb-4">ğŸ”‘ è®¾ç½® API å¯†é’¥</h2>
            <p class="text-sm text-yellow-700 mb-4">ä¸ºäº†ä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œå¯†é’¥å°†å­˜å‚¨åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>
            <div class="flex flex-col gap-3">
                <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ Gemini API Key (AIzaSy...)" 
                    class="w-full p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                <button id="saveKeyButton" class="w-full py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition duration-150">
                    ä¿å­˜å¯†é’¥å¹¶å¼€å§‹ä½¿ç”¨
                </button>
            </div>
        </section>

        <!-- ä¸»è¦åº”ç”¨å†…å®¹ (è®¾ç½® Key åæ˜¾ç¤º) -->
        <div id="mainContent" class="hidden">
            
            <!-- å¯†é‘°ç®¡ç† (é‡ç½®é€£çµ) -->
            <div class="flex justify-end mb-4">
                <button id="resetKeyButton" class="text-xs text-gray-400 hover:text-indigo-600 underline transition duration-150">
                    é‡ç½®/æ›´æ¢ API å¯†é’¥
                </button>
            </div>

            <!-- æ­¥éª¤ 1: åœ–ç‰‡ä¸Šå‚³ -->
            <section class="mb-8 p-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-indigo-800 mb-4">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ‰‹å†™é€è´§å•ç…§ç‰‡ (å¯å¤šé€‰)</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="file" id="imageInput" accept="image/*" multiple
                        class="flex-grow text-sm text-gray-700
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-200 file:text-indigo-800
                        hover:file:bg-indigo-300 transition duration-150"
                    />
                    <button id="clearImageButton"
                            class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg text-sm hover:bg-red-600 transition duration-150 disabled:opacity-50"
                            disabled>
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å›¾ç‰‡
                    </button>
                </div>
            </section>

            <!-- æ­¥é©Ÿ 2: è™•ç†èˆ‡æŒ‡ç¤º -->
            <section class="mb-8">
                <button id="processButton"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50"
                        disabled>
                    å¼€å§‹å¤„ç†æ‰€æœ‰å›¾ç‰‡å¹¶è½¬åŒ–
                </button>
                <div id="loadingIndicator" class="mt-4 p-3 text-center rounded-lg bg-indigo-50 border border-indigo-200 hidden">
                    <div class="animate-spin inline-block w-5 h-5 border-3 border-indigo-500 border-t-transparent rounded-full"></div>
                    <span id="loadingMessage" class="ml-3 text-indigo-600 font-medium">æ­£åœ¨è¯»å–å›¾ç‰‡ 1 / 0ï¼Œè¯·ç¨å€™...</span>
                </div>
                <div id="messageBox" class="mt-4 p-3 rounded-lg text-sm font-medium hidden"></div>
            </section>

            <!-- æ­¥é©Ÿ 3: çµæœèˆ‡åŒ¯å‡º -->
            <section id="resultsSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“¦ æ±‡æ€»è¯†åˆ«ç»“æœè¡¨æ ¼ (å·²æŒ‰å•å·æ’åº)</h2>
                
                <div id="tableOutput" class="overflow-x-auto mb-4 border border-gray-200 rounded-lg shadow-md">
                    <!-- è¡¨æ ¼å…§å®¹å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
                </div>

                <button id="exportButton"
                        class="w-full py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-150 disabled:opacity-50"
                        disabled>
                    â¬‡ï¸ ä¸‹è½½ CSV æ–‡ä»¶ (Excel æ ¼å¼)
                </button>
            </section>

            <!-- æ­¥é©Ÿ 4: é è¦½ -->
            <section id="previewSection" class="mt-8 border-t border-gray-200 pt-6 hidden">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">é¦–å¼ å›¾ç‰‡é¢„è§ˆ</h2>
                <img id="imagePreview" class="max-w-full h-auto rounded-lg shadow-lg border border-gray-300" />
            </section>
        </div>
    </div>

    <script type="module">
        // --- è¨­å®šèˆ‡é…ç½® ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // æ‡‰ç”¨ç‹€æ…‹å„²å­˜
        const appState = {
            apiKey: "", // API å¯†é‘°ï¼Œå¾ LocalStorage è®€å–
            files: [], // ä¸Šå‚³çš„æ–‡ä»¶åˆ—è¡¨
            extractedItems: [], // æå–çš„ç¸½æ•¸æ“šåˆ—è¡¨
            isProcessing: false, // è™•ç†ç‹€æ…‹æ¨™è¨˜
        };

        // DOM å…ƒç´ åƒè€ƒ
        const D = {
            app: document.getElementById('app'),
            apiKeySection: document.getElementById('apiKeySection'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyButton: document.getElementById('saveKeyButton'),
            resetKeyButton: document.getElementById('resetKeyButton'),
            mainContent: document.getElementById('mainContent'),
            
            imageInput: document.getElementById('imageInput'),
            clearImageButton: document.getElementById('clearImageButton'),
            processButton: document.getElementById('processButton'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            loadingMessage: document.getElementById('loadingMessage'),
            tableOutput: document.getElementById('tableOutput'),
            exportButton: document.getElementById('exportButton'),
            messageBox: document.getElementById('messageBox'),
            resultsSection: document.getElementById('resultsSection'),
            imagePreview: document.getElementById('imagePreview'),
            previewSection: document.getElementById('previewSection'),
        };

        // --- å¯†é‘°ç®¡ç†é‚è¼¯ (Local Storage) ---
        
        function initKeySystem() {
            // æª¢æŸ¥æœ¬åœ°å„²å­˜ä¸­æ˜¯å¦æœ‰å¯†é‘°
            const storedKey = localStorage.getItem('GEMINI_API_KEY');
            if (storedKey) {
                appState.apiKey = storedKey;
                showMainContent(); // å¦‚æœæœ‰å¯†é‘°ï¼Œé¡¯ç¤ºä¸»å…§å®¹
            } else {
                showKeySetup(); // å¦‚æœæ²’æœ‰ï¼Œé¡¯ç¤ºå¯†é‘°è¨­å®šå€
            }
        }

        function showKeySetup() {
            D.apiKeySection.classList.remove('hidden');
            D.mainContent.classList.add('hidden');
        }

        function showMainContent() {
            D.apiKeySection.classList.add('hidden');
            D.mainContent.classList.remove('hidden');
        }

        D.saveKeyButton.addEventListener('click', () => {
            const inputKey = D.apiKeyInput.value.trim();
            // ç°¡å–®é©—è­‰å¯†é‘°æ ¼å¼ (Gemini Keys usually start with AIza)
            if (inputKey && inputKey.startsWith('AIza')) {
                localStorage.setItem('GEMINI_API_KEY', inputKey);
                appState.apiKey = inputKey;
                showMainContent();
                showMessage('å¯†é’¥å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ã€‚', 'success');
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Gemini API Key (é€šå¸¸ä»¥ AIza å¼€å¤´)');
            }
        });

        D.resetKeyButton.addEventListener('click', () => {
            if(confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ä¿å­˜çš„ API å¯†é’¥å—ï¼Ÿæ¸…é™¤åéœ€è¦é‡æ–°è¾“å…¥ã€‚')) {
                localStorage.removeItem('GEMINI_API_KEY'); // ä»æœ¬åœ°å„²å­˜ä¸­ç§»é™¤
                appState.apiKey = "";
                D.apiKeyInput.value = "";
                resetApp(); // é‡ç½®æ‡‰ç”¨ç‹€æ…‹
                showKeySetup(); // é¡¯ç¤ºå¯†é‘°è¨­å®šå€
            }
        });

        // --- è¼”åŠ©å‡½æ•¸ ---

        // é¡¯ç¤ºè¨Šæ¯æ¡†
        function showMessage(message, type = 'info') {
            D.messageBox.textContent = message;
            // ç§»é™¤æ‰€æœ‰é¡åˆ¥ä¸¦æ ¹æ“š type æ·»åŠ é¡è‰²
            D.messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');

            if (type === 'error') {
                D.messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                D.messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                D.messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
            D.messageBox.classList.remove('hidden');
        }

        // é‡ç½®æ‡‰ç”¨ç‹€æ…‹
        function resetApp() {
            appState.files = [];
            appState.extractedItems = [];
            appState.isProcessing = false;
            
            D.imageInput.value = '';
            D.processButton.disabled = true;
            D.clearImageButton.disabled = true;
            D.exportButton.disabled = true;
            
            D.previewSection.classList.add('hidden');
            D.resultsSection.classList.add('hidden');
            D.loadingIndicator.classList.add('hidden');
            
            D.tableOutput.innerHTML = '';
            D.messageBox.classList.add('hidden');
            if(appState.apiKey) showMessage('è¯·é€‰æ‹©ä¸€å¼ æˆ–å¤šå¼ é€è´§å•å›¾ç‰‡å¼€å§‹å¤„ç†ã€‚', 'info');
        }

        // å°‡ File è½‰æ›ç‚º Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- æ•¸æ“šè™•ç†èˆ‡æ¸²æŸ“ ---

        // è½‰æ›ç‚º CSV æ ¼å¼ (åŒ…å«é€è²¨å–®è™Ÿ)
        function toCSV(items) {
            // CSV æ¨™é ­: é€è²¨å–®è™Ÿ, åç¨±åŠè¦æ ¼, å–®ä½, æ•¸é‡, å–®åƒ¹
            const headers = ["é€è´§å•å·", "åç§°åŠè§„æ ¼", "å•ä½", "æ•°é‡", "å•ä»·"];
            let csv = headers.join(',') + '\n';

            items.forEach(item => {
                const row = [
                    `"${String(item.deliveryNo || '-').replace(/"/g, '""')}"`, // é€è²¨å–®è™Ÿ
                    `"${String(item.nameAndSpec || '-').replace(/"/g, '""')}"`, // åç¨±åŠè¦æ ¼
                    String(item.unit || 'åª'), // å–®ä½ (é è¨­ç‚º 'åª')
                    String(item.quantity || 0), // æ•¸é‡
                    String(item.unitPrice || 0) // å–®åƒ¹
                ];
                csv += row.join(',') + '\n';
            });

            return csv.trim();
        }

        // æ¸²æŸ“ HTML è¡¨æ ¼ (åŒ…å«é€è²¨å–®è™Ÿ)
        function renderTable(items) {
            if (!items || items.length === 0) {
                D.tableOutput.innerHTML = '<p class="text-center text-gray-500 p-4">æœªæå–åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ã€‚</p>';
                return;
            }

            // è¡¨æ ¼æ¨™é ­ï¼šç¬¬ä¸€æ¬„æ˜¯é€è²¨å–®è™Ÿ
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider rounded-tl-lg">é€è´§å•å·</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">åç§°åŠè§„æ ¼</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">å•ä½</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-indigo-700 uppercase tracking-wider">æ•°é‡</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-indigo-700 uppercase tracking-wider rounded-tr-lg">å•ä»·</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            items.forEach((item, index) => {
                const quantity = item.quantity || 0;
                const unitPrice = item.unitPrice || 0;
                const priceDisplay = typeof unitPrice === 'number' ? `Â¥${unitPrice.toFixed(2)}` : '-';
                
                let priceClass = "text-gray-700";
                let rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                // å¦‚æœ isPriceCertain ç‚º falseï¼Œå‰‡æ¨™ç´…
                if (item.isPriceCertain === false) {
                     priceClass = "text-red-700 font-bold bg-red-100 rounded px-1";
                }

                html += `
                    <tr class="${rowClass} hover:bg-indigo-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-blue-600">${item.deliveryNo || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${item.nameAndSpec || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${item.unit || 'åª'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right text-gray-700">${quantity}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right ${priceClass}">${priceDisplay}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            D.tableOutput.innerHTML = html;
        }

        // ä¸‹è¼‰ CSV æª”æ¡ˆ
        function downloadCSV() {
            const csvData = toCSV(appState.extractedItems);
            const bom = "\ufeff"; // BOM (Byte Order Mark) ç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            const blob = new Blob([bom + csvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'é€è´§å•æ±‡æ€»æ•°æ®.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMessage('CSV æª”æ¡ˆå·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ã€‚', 'success');
        }

        // --- Gemini API æ ¸å¿ƒé‚è¼¯ ---

        // å‘¼å« Gemini API é€²è¡Œåœ–ç‰‡è­˜åˆ¥
        async function callGeminiAPI(base64Data, mimeType, attempt = 1) {
            const MAX_RETRIES = 5;
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${appState.apiKey}`;

            // çµæ§‹åŒ– JSON è¼¸å‡ºçš„ Schema
            const itemSchema = {
                type: "OBJECT",
                properties: {
                    "deliveryNo": { "type": "STRING", "description": "é€è´§å•å· (No)" }, // æå–é€è´§å•å·
                    "items": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "nameAndSpec": { "type": "STRING", "description": "åç§°åŠè§„æ ¼ã€‚ä»…æå–'åç§°åŠè§„æ ¼'æ ä¸‹çš„å†…å®¹ï¼ŒåŒ…å«æè´¨å‰ç¼€(å¦‚PE,OPP)å’Œå°ºå¯¸ã€‚ä¸è¦æå–'è´§å·'æ çš„å†…å®¹ã€‚å¦‚æœè§„æ ¼æ˜¯æ•°å­—ï¼Œè¯·ç”¨*å·è¿æ¥ï¼Œå¦‚ 30*40+5ã€‚" },
                                "quantity": { "type": "NUMBER", "description": "æ•°é‡" },
                                "unitPrice": { "type": "NUMBER", "description": "å•ä»·" },
                                "isPriceCertain": { "type": "BOOLEAN", "description": "å¦‚æœå•ä»·æ•°å­—å› æ¶‚æ”¹ã€æ¨¡ç³Šã€åˆ’çº¿ä¿®æ”¹ç­‰åŸå› éš¾ä»¥è¾¨è®¤ï¼Œè®¾ä¸ºfalseï¼Œå¦åˆ™ä¸ºtrueã€‚" }
                            },
                            required: ["nameAndSpec", "quantity", "unitPrice", "isPriceCertain"]
                        }
                    }
                },
                required: ["deliveryNo", "items"] // è¦æ±‚å¿…é ˆæœ‰é€è²¨å–®è™Ÿå’Œé …ç›®åˆ—è¡¨
            };

            // ç³»çµ±æŒ‡ä»¤ (System Prompt) - å‘Šè¨´æ¨¡å‹å¦‚ä½•æ‰®æ¼”
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„é€è²¨å–®æ•¸æ“šæå–åŠ©æ‰‹ã€‚
            1. **ç›®æ¨™**ï¼šæå–"é€è´§å•å·"ä»¥åŠåˆ—è¡¨ä¸­çš„â€œåç§°åŠè§„æ ¼â€ã€â€œæ•°é‡â€ã€â€œå•ä»·â€ã€‚é»˜è®¤å•ä½ä¸ºâ€œåªâ€ã€‚
            2. **è§„æ ¼æ ¼å¼**ï¼š
               - æ•°å­—*æ•°å­—+æ•°å­—+æ•°å­—.æ•°å­— (å¦‚ 26*37+5+2.5)
               - æ•°å­—*æ•°å­—+æ•°å­— (å¦‚ 30*40+5)
               - æ•°å­—*æ•°å­—*æ•°å­— (å¦‚ 52*38*67 æˆ– 30*40*50)
               - æ•°å­—*æ•°å­— (å¦‚ 50*70)
               - **æ³¨æ„**ï¼šå¦‚æœé‡åˆ°â€œé˜²æ°´è¢‹â€ç­‰ä¸­æ–‡åç¨±ï¼Œå…¶å¾Œç·Šè·Ÿæ•¸å­—è¦æ ¼ï¼Œå‹™å¿…æå–å®Œæ•´ï¼Œä¸”æ•¸å­—é–“ç”¨*è™Ÿé€£æ¥ã€‚
            3. **æ’é™¤å¹²æ“¾**ï¼šç»å¯¹ä¸è¦æå–â€œè´§å·â€æ çš„å†…å®¹ã€‚åªæå–â€œåç§°åŠè§„æ ¼â€æ ä¸‹çš„æ‰‹å†™å­—ã€‚
            4. **å¤„ç†ä¿®æ”¹**ï¼šå¦‚æœæŸè¡Œè¢«æ˜æ˜¾åˆ’æ‰ï¼Œè¯·å¿½ç•¥ã€‚å¦‚æœæŸè¡Œæ•°æ®æœ‰æ¶‚æ”¹ï¼Œæå–æœ€ç»ˆçœ‹èµ·æ¥æœ‰æ•ˆçš„æ•°å­—ï¼Œå¹¶å°† 'isPriceCertain' è®¾ä¸º false ä»¥æç¤ºäººå·¥å¤æ ¸ã€‚
            5. **çº¯æ·¨è¼¸å‡º**ï¼šå°†æ‰€æœ‰ä¹˜è™Ÿ 'X' æˆ– 'x' çµ±ä¸€è½‰ç‚º '*'ã€‚`;
            
            // ç”¨æˆ¶æŸ¥è©¢ (User Query) - å…·é«”ä»»å‹™
            const userQuery = "è¯·æå–å›¾ç‰‡ä¸­çš„é€è´§å•å·å’Œæœ‰æ•ˆé€è´§è®°å½•ã€‚åç§°åŠè§„æ ¼éœ€åŒ…å«ä¸­æ–‡åï¼ˆå¦‚é˜²æ°´è¢‹ï¼‰å’Œæè´¨å‰ç¼€ã€‚å¦‚æœå•ä»·æˆ–æ•°é‡æœ‰æ¶‚æ”¹å«Œç–‘ï¼Œè¯·æ ‡è®°éœ€æŸ¥éªŒã€‚";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: itemSchema
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                if (!appState.apiKey) {
                    throw new Error("è¯·å…ˆè®¾ç½® API Keyã€‚");
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Request Failed (å˜—è©¦ ${attempt}): HTTP Status ${response.status}`, errorText);
                    throw new Error(`AI è¯·æ±‚å¤±è´¥ã€‚çŠ¶æ€ç : ${response.status}ã€‚è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ã€‚`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    const cleanedJsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();
                    
                    const resultData = JSON.parse(cleanedJsonString);
                    const deliveryNo = resultData.deliveryNo || "";
                    const items = resultData.items || [];

                    // å°‡é€è²¨å–®è™Ÿé™„åŠ åˆ°æ¯å€‹é …ç›®ä¸Šï¼Œæ–¹ä¾¿åœ¨å¹³é¢è¡¨æ ¼ä¸­é¡¯ç¤º
                    return Array.isArray(items) 
                        ? items.map(item => ({ ...item, deliveryNo })).filter(item => item && item.nameAndSpec) 
                        : [];
                } else {
                    throw new Error("æ¨¡å‹è¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼é”™è¯¯ã€‚");
                }

            } catch (error) {
                // å¯¦ä½œæŒ‡æ•¸é€€é¿é‡è©¦
                if (attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                    console.warn(`API å‘¼å«å¤±æ•—ã€‚å°‡åœ¨ ${Math.round(delay / 1000)} ç§’å¾Œé‡è©¦... (å˜—è©¦ ${attempt}/${MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(base64Data, mimeType, attempt + 1);
                }
                throw new Error("API å‘¼å«æœ€çµ‚å¤±æ•—ã€‚è©³ç´°ä¿¡æ¯: " + error.message);
            }
        }

        // --- ä¸»è¦è™•ç†é‚è¼¯ ---

        async function handleProcessAll() {
            if (appState.isProcessing || appState.files.length === 0) return;

            appState.isProcessing = true;
            appState.extractedItems = [];
            D.processButton.disabled = true;
            D.clearImageButton.disabled = true;
            D.exportButton.disabled = true;
            D.resultsSection.classList.add('hidden');
            D.tableOutput.innerHTML = '';
            D.loadingIndicator.classList.remove('hidden');
            D.messageBox.classList.add('hidden');
            
            const totalFiles = appState.files.length;

            for (let i = 0; i < totalFiles; i++) {
                const file = appState.files[i];
                const fileNumber = i + 1;
                
                D.loadingMessage.textContent = `æ­£åœ¨å¤„ç†å›¾ç‰‡ ${fileNumber} / ${totalFiles} (${file.name})...`;
                showMessage(`å¼€å§‹å¤„ç†ç¬¬ ${fileNumber} å¼ å›¾ç‰‡...`, 'info');

                try {
                    const base64Data = await fileToBase64(file);
                    const mimeType = file.type;
                    
                    const items = await callGeminiAPI(base64Data, mimeType);

                    if (items && items.length > 0) {
                        // å®¢æˆ¶ç«¯å¾Œè™•ç†ä¿®æ­£ï¼šä¿®å¾©é˜²æ°´è¢‹è¦æ ¼ä¹˜è™Ÿä¸Ÿå¤±å•é¡Œ
                        items.forEach(item => {
                            if (item.nameAndSpec && item.nameAndSpec.includes('é˜²æ°´è¢‹')) {
                                // å•Ÿç™¼å¼è¦å‰‡: å¦‚æœè¦æ ¼æ˜¯ 6 ä½æ•¸å­—é€£åœ¨ä¸€èµ·ä¸”æ²’æœ‰ * è™Ÿï¼Œå‰‡å¼·åˆ¶æ’å…¥ *
                                item.nameAndSpec = item.nameAndSpec.replace(/(\d{2})(\d{2})(\d{2})/g, (match, p1, p2, p3) => {
                                    if (!match.includes('*')) {
                                        return `${p1}*${p2}*${p3}`;
                                    }
                                    return match;
                                });
                            }
                        });

                        appState.extractedItems.push(...items);
                        showMessage(`ç¬¬ ${fileNumber} å¼ å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæå–åˆ° ${items.length} æ¡æ•°æ®ã€‚`, 'success');
                    } else {
                        showMessage(`ç¬¬ ${fileNumber} å¼ å›¾ç‰‡å¤„ç†å®Œæˆï¼Œä½†æœªæå–åˆ°æœ‰æ•ˆæ•°æ®ã€‚`, 'info');
                    }

                } catch (error) {
                    console.error(`å¤„ç†æ–‡ä»¶ ${fileNumber} (${file.name}) é”™è¯¯:`, error);
                    showMessage(`ç¬¬ ${fileNumber} å¼ å›¾ç‰‡å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            // 3. æ’åºé‚è¼¯: æ ¹æ“šé€è²¨å–®è™Ÿå¾å°åˆ°å¤§æ’åº
            appState.extractedItems.sort((a, b) => {
                const aNum = parseInt(a.deliveryNo) || 0;
                const bNum = parseInt(b.deliveryNo) || 0;
                return aNum - bNum; // æ•¸å­—å¾å°åˆ°å¤§æ’åº
            });

            D.loadingIndicator.classList.add('hidden');
            appState.isProcessing = false;
            D.processButton.disabled = false;
            D.clearImageButton.disabled = false;

            if (appState.extractedItems.length > 0) {
                renderTable(appState.extractedItems);
                D.resultsSection.classList.remove('hidden');
                D.exportButton.disabled = false;
                showMessage(`æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆï¼æˆåŠŸæå– ${appState.extractedItems.length} æ¡æ•°æ®ã€‚`, 'success');
            } else {
                D.resultsSection.classList.add('hidden');
                showMessage(`å¤„ç†å®Œæ¯•ã€‚æœªèƒ½ä» ${totalFiles} ä¸ªæ–‡ä»¶ä¸­æå–åˆ°ä»»ä½•æ•°æ®ã€‚`, 'info');
            }
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---

        D.imageInput.addEventListener('change', (event) => {
            appState.files = Array.from(event.target.files);
            D.messageBox.classList.add('hidden');
            
            if (appState.files.length > 0) {
                D.processButton.disabled = false;
                D.clearImageButton.disabled = false;
                
                // é è¦½ç¬¬ä¸€å¼µåœ–
                const firstFile = appState.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    D.imagePreview.src = e.target.result;
                    D.previewSection.classList.remove('hidden');
                };
                reader.readAsDataURL(firstFile);
                
                showMessage(`å·²é€‰æ‹© ${appState.files.length} å¼ å›¾ç‰‡ï¼Œè¯·ç‚¹å‡»å¼€å§‹å¤„ç†ã€‚`, 'info');
            } else {
                resetApp();
            }
        });

        D.clearImageButton.addEventListener('click', () => {
            resetApp();
        });

        D.processButton.addEventListener('click', handleProcessAll);

        D.exportButton.addEventListener('click', downloadCSV);

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', initKeySystem);
    </script>
</body>
</html>
